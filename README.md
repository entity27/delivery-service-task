# delivery-service-task
Микросервис "Службы междунарожной доставки". Тестовое задание в компанию «A».

# Структура проекта
- `docker` - файлы для апи, селери и проведения тестов
  - `scripts` - скрипты для использования внутри контейнеров
- `envs` - файлы с переменными окружения
  - `delivery.env.example` - пример для докера
  - `local.delivery.env.example` - пример для локальной разработки
  - `mysql.env.example` - пример для mysql контейнера
- `requirements` - зависимости
  - `requirements.txt` - для обычного контейнера
  - `requirements.test.txt` - для контейнера тестов
- `scripts` - утилиты для разработки
- `src` - исходный код проекта
  - `alembic` - менеджмент миграций
  - `backgrounds` - celery задачи
  - `config` - общая кофигурация проекта
  - `external` - взаимодействие с внешними сервисами
  - `utils` - полезные зависимости
  - `...` - доменные пакеты с моделями, роутами и т.п.
- `tests` - тесты

# Подготовка переменных окружения
- В случае локального запуска
  - Копируем `envs/local.delivery.env.example` -> `envs/local.delivery.env`
- В случае запуска в докере
  - Копируем `envs/delivery.env.example` -> `envs/delivery.env`
- Копируем `envs/mysql.env.example` -> `envs/mysql.env` - переменные для mysql контейнера

# Запуск проекта
## Локально

Через Poetry:
```bash
poetry install
```

Запуск API:
```bash
uvicorn src.main:app --env-file ./envs/local.delivery.env --reload
```

Запуск Celery:
```bash
celery -A src.backgrounds worker -B -l INFO --queues some_task
```

Хук для разработки:
```bash
pre-commit install
```

## Докер
```bash
docker compose up -d
```

# Обзор

## Стек

- `Celery` + `RabbitMQ` + `Redis` - отложенные задачи 
через брокер и БД результатов
- `Redis` - Кэш, хранение статусов регистрации посылок
- `MySQL` - База данных
- `Alembic` - Миграции
- `SQLAlchemy` - ORM
- `FastAPI` - Ну, тут понятно
- `Docker` + `Docker Compose` - оркестрация
контейнеров зависимостей и проведение тестов

## Логирование
Используем обычный `logging`

Задаём конфигурацию в `src/config/logging.py`,
подключаем логгер `sqlalchemy` в случае дебаггинга

Импортируем в `__init__.py` пакета `src`, чтобы
удостовериться, что конфигурация была учтена

## Миграции и структура моделей
`src/alembic/env.py` - скрипт миграций

Файлы моделей распределены по разным модулям

Для обеспечения исправного определения изменений
Alembic'ом и исправной работы SQLAlchemy, требуется
загрузка всех определённых в проекте моделей в runtime.

Это обеспечивается за счёт
`src.utils.helpers.autoimport_models`

Функция производит импорт всех моделей из разных доменов
проекта


## API

### `GET /packages/` - Список посылок
Отдаёт список зарегистрированных пользователем посылок

Требует сессию пользователя (cookie)

Доступная фильтрация:
- `type` - тип посылки
- `has_cost` - стоимость доставки посылки

Включает пагинацию

### `GET /packages/{package_id}/` - Получение посылки
Детальное получение посылки по её ID,
требует сессию пользователя

### `POST /packages/` - Регистрация посылки
Требует токен сессии, выполняет создание объекта сессии

Сохраняет статус посылки в Redis для
дальнейшего отслеживания процесса её регистрации

Выполняет запуск отложенной Celery задачи через RabbitMQ

Сама задача:
- Получает необходимые данные, настроена
на перезапуск в случае ошибки запроса
- Выполняет запрос через кэш-прослойку к API ежедневного
курса валют CBR
- Выполняет расчёт стоимости доставки исходя из курса
доллара
- Создаёт объект посылки в БД
- Если на како-то этапе произошла ошибка, либо
процесс завершился успешно, устанавливаем соответствующий
статус посылки в Redis'е
- Кэш запросов с CBR хранится сутки с момента получения

Возвращает `UUID` **статуса** посылки

### `GET /packages/status/{status_uuid}/` - Статус посылки
Получает статус посылки:
- Регистрация завершена / нет
- Во время регистрации произошла ошибка / нет
- ID зарегестрированной посылки / нет

Требует `UUID` посылки, полученный на этапе регистрации

Хранятся в Redis. Автоматически очищаются спустя
сутки с момента установления

### `GET /types/` - Типы посылок
Возвращает список всех типов посылок в системе

### `GET /sessions/new/` - Получить сессию
Устанавливает случайную `cookie` сессию
для пользователя
